<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>VisionSense Feature Studio</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,container-queries"></script>
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 999px; }
        .glass {
            background: rgba(15, 23, 42, 0.75);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(248, 250, 252, 0.08);
        }
        .dropzone-active {
            border-color: #38bdf8 !important;
            background-color: rgba(56, 189, 248, 0.08);
        }
    </style>
</head>
<body class="min-h-screen bg-slate-950 text-slate-100 selection:bg-cyan-500/30">
    <div class="mx-auto flex max-w-5xl flex-col gap-8 px-4 py-10">
        <header class="text-center space-y-2">
            <p class="inline-flex items-center gap-2 rounded-full border border-slate-800 px-3 py-1 text-xs uppercase tracking-wide text-slate-400">
                <span class="h-2 w-2 rounded-full bg-emerald-400"></span>
                Real-time Vision Intelligence
            </p>
            <h1 class="text-3xl font-semibold tracking-tight text-white">VisionSense Feature Studio</h1>
            <p class="text-base text-slate-400">
                Drag in any video to run the VisionSense pipeline and get instant scene analytics.
            </p>
        </header>

        <main class="grid gap-6 lg:grid-cols-[1.1fr,0.9fr]">
            <section class="glass rounded-2xl p-6 shadow-2xl shadow-cyan-500/5">
                <div id="dropZone" class="group relative flex min-h-[260px] cursor-pointer flex-col items-center justify-center rounded-xl border border-dashed border-slate-700 p-6 text-center transition hover:border-cyan-400/60 hover:bg-white/5">
                    <input id="fileInput" type="file" accept="video/*" class="hidden" />
                    <div class="flex flex-col items-center gap-4">
                        <div class="relative">
                            <div class="absolute inset-0 animate-ping rounded-full bg-cyan-500/30"></div>
                            <div class="rounded-full bg-slate-900/70 p-3 ring-1 ring-slate-700">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-9 w-9 text-cyan-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V7M3 7l4.6-3.45a2 2 0 012.4 0L15 7M3 7h18M7 10h.01M12 10h.01M17 10h.01" />
                                </svg>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <p class="text-lg font-medium text-white">Drag & drop your footage</p>
                            <p class="text-sm text-slate-400">Highway cams, retail CCTV, logistic feeds & more. Max 500MB.</p>
                        </div>
                        <button id="browseButton" class="rounded-full bg-white/10 px-4 py-2 text-sm font-semibold text-white transition hover:bg-cyan-500/80">
                            Browse Files
                        </button>
                    </div>
                    <p id="fileName" class="mt-6 text-sm text-cyan-200/80">No file selected.</p>
                </div>

                <div class="mt-6 space-y-4">
                    <div class="space-y-1">
                        <div class="flex items-center justify-between text-xs uppercase text-slate-400 tracking-[0.2em]">
                            <span>Status</span>
                            <span id="statusText">Idle</span>
                        </div>
                        <div class="h-2 w-full overflow-hidden rounded-full bg-slate-800">
                            <div id="progressFill" class="h-full w-0 rounded-full bg-gradient-to-r from-cyan-400 via-blue-500 to-emerald-400 transition-all"></div>
                        </div>
                    </div>
                    <button id="uploadButton" class="inline-flex w-full items-center justify-center rounded-xl bg-gradient-to-r from-cyan-500 to-blue-600 px-4 py-3 font-semibold text-white shadow-lg shadow-cyan-500/30 transition hover:brightness-110 disabled:cursor-not-allowed disabled:opacity-50" disabled>
                        Run Feature Extraction
                    </button>
                </div>
            </section>

            <section class="space-y-4">
                <div class="glass rounded-2xl p-6 shadow-xl shadow-slate-950/60">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm uppercase tracking-[0.25em] text-cyan-300">Insights</p>
                            <h2 class="text-lg font-semibold text-white">Scene Intelligence Snapshot</h2>
                        </div>
                        <span class="rounded-full bg-emerald-500/10 px-3 py-1 text-xs font-semibold text-emerald-400">Live</span>
                    </div>
                    <div id="cardsContainer" class="mt-5 grid gap-3 text-sm text-slate-300">
                        <p class="text-slate-500">Upload a clip to see key scene metrics.</p>
                    </div>
                </div>

                <div class="glass rounded-2xl p-6 shadow-xl shadow-slate-950/60">
                    <div class="flex items-center justify-between">
                        <h2 class="text-lg font-semibold text-white">Raw Feature Payload</h2>
                        <button id="copyJson" class="text-xs font-medium text-cyan-300 hover:text-white">Copy JSON</button>
                    </div>
                    <pre id="jsonOutput" class="mt-3 max-h-80 overflow-auto rounded-xl bg-slate-950/70 p-4 text-xs text-slate-200">awaiting data…</pre>
                </div>
            </section>
        </main>
    </div>

    <script>
        const dropZone = document.getElementById("dropZone");
        const fileInput = document.getElementById("fileInput");
        const browseButton = document.getElementById("browseButton");
        const fileName = document.getElementById("fileName");
        const uploadButton = document.getElementById("uploadButton");
        const statusText = document.getElementById("statusText");
        const progressFill = document.getElementById("progressFill");
        const cardsContainer = document.getElementById("cardsContainer");
        const jsonOutput = document.getElementById("jsonOutput");
        const copyJson = document.getElementById("copyJson");

        let selectedFile = null;
        let latestPayload = null;

        const metricDefinitions = [
            { key: "duration_seconds", label: "Duration (s)", format: (v) => v ? v.toFixed(2) : "—" },
            { key: "frames_processed", label: "Frames Processed", format: (v) => v?.toLocaleString() ?? "—" },
            { key: "hard_cuts", label: "Hard Cuts", format: (v) => v ?? "—" },
            { key: "avg_motion_magnitude", label: "Avg Motion", format: (v) => v ? v.toFixed(3) : "0.000" },
            { key: "text_present_ratio", label: "Text Presence", format: (v) => v ? (v * 100).toFixed(1) + "%" : "0%" },
            { key: "people_detections", label: "People Detections", format: (v) => v ?? "—" },
            { key: "object_detections", label: "Object Detections", format: (v) => v ?? "—" },
            { key: "person_to_object_ratio", label: "Person/Object Ratio", format: (v) => typeof v === "number" ? v.toFixed(2) : "n/a" }
        ];

        function setStatus(message, progress = null) {
            statusText.textContent = message;
            if (progress !== null) {
                progressFill.style.width = progress + "%";
            }
        }

        function resetProgress() {
            progressFill.style.width = "0%";
            statusText.textContent = "Idle";
        }

        function renderCards(data) {
            const cards = metricDefinitions.map(({ key, label, format }) => {
                const value = data[key];
                return `
                    <div class="rounded-xl border border-white/5 bg-gradient-to-br from-slate-900/70 to-slate-900/30 p-4">
                        <p class="text-xs uppercase tracking-[0.3em] text-slate-500">${label}</p>
                        <p class="mt-2 text-2xl font-semibold text-white">${format(value)}</p>
                    </div>
                `;
            }).join("");
            cardsContainer.innerHTML = `<div class="grid gap-3 sm:grid-cols-2">${cards}</div>`;
        }

        function handleFiles(files) {
            if (!files || !files.length) return;
            selectedFile = files[0];
            fileName.textContent = selectedFile.name;
            uploadButton.disabled = false;
            resetProgress();
            statusText.textContent = "Ready";
        }

        dropZone.addEventListener("dragover", (event) => {
            event.preventDefault();
            dropZone.classList.add("dropzone-active");
        });
        dropZone.addEventListener("dragleave", () => dropZone.classList.remove("dropzone-active"));
        dropZone.addEventListener("drop", (event) => {
            event.preventDefault();
            dropZone.classList.remove("dropzone-active");
            handleFiles(event.dataTransfer.files);
        });

        dropZone.addEventListener("click", () => fileInput.click());
        browseButton.addEventListener("click", (event) => {
            event.stopPropagation();
            fileInput.click();
        });
        fileInput.addEventListener("change", (event) => handleFiles(event.target.files));

        uploadButton.addEventListener("click", () => {
            if (!selectedFile) return;
            uploadButton.disabled = true;
            const formData = new FormData();
            formData.append("file", selectedFile, selectedFile.name);
            const xhr = new XMLHttpRequest();
            xhr.open("POST", "/extract");

            xhr.upload.onprogress = (event) => {
                if (event.lengthComputable) {
                    const percent = Math.round((event.loaded / event.total) * 100);
                    setStatus(`Uploading ${percent}%`, percent);
                }
            };

            xhr.onloadstart = () => setStatus("Initializing…", 10);
            xhr.onerror = () => {
                setStatus("Upload failed", 0);
                uploadButton.disabled = false;
            };

            xhr.onload = () => {
                if (xhr.status >= 200 && xhr.status < 300) {
                    setStatus("Processing complete", 100);
                    try {
                        latestPayload = JSON.parse(xhr.responseText);
                        renderCards(latestPayload);
                        jsonOutput.textContent = JSON.stringify(latestPayload, null, 2);
                    } catch (error) {
                        jsonOutput.textContent = "Failed to parse response.";
                    }
                } else {
                    setStatus("Processing error", 0);
                    jsonOutput.textContent = `Server error (${xhr.status}): ${xhr.responseText}`;
                }
                uploadButton.disabled = false;
            };

            xhr.send(formData);
        });

        copyJson.addEventListener("click", async () => {
            if (!latestPayload) {
                navigator.clipboard.writeText("");
                return;
            }
            await navigator.clipboard.writeText(JSON.stringify(latestPayload, null, 2));
            copyJson.textContent = "Copied!";
            setTimeout(() => (copyJson.textContent = "Copy JSON"), 1200);
        });
    </script>
</body>
</html>